# SKIP THIS SECTION - THIS WAS WRONG

## Supabase - An Open Source Database

We're gonna go through the process of setting up Supabase, a database and auth platform.

You'll want to start by creating an account, you can use you GitHub profile for convenience.

<br />

import Image from "next/image";

<Image
  src="/supabase_signup.png"
  alt="Screenshot of our initial landing page with navbar"
  width={1000}
  height={1000}
/>

Once you're logged in, you'll want to create a new project:

<br />

<Image
  src="/supabase_new.png"
  alt="Screenshot of our initial landing page with navbar"
  width={1000}
  height={1000}
/>

Give it a simple title, a password, and select a region (nearest to where the app is being deployed).

<br />

<Image
  src="/supabase_set.png"
  alt="Screenshot of our initial landing page with navbar"
  width={1000}
  height={1000}
/>

Wait for your new database to finish provisioning, then click the connect button:

<br />

<Image
  src="/supabase_connect.png"
  alt="Screenshot of our initial landing page with navbar"
  width={1000}
  height={1000}
/>

Finally, click on the App Frameworks tab, and you'll see the following:

<br />

<Image
  src="/supabase_next.png"
  alt="Screenshot of our initial landing page with navbar"
  width={1000}
  height={1000}
/>

The file names tell you where the different pieces of information need to go.

## Install Supabase in our project

Now that we've set things up on Supabase, we can install its packages into our project:

In your project terminal, run the following command:

```sh filename="terminal" copy
npm install @supabase/ssr
```

## .env.local

Next up, we'll make a .env.local file in our source directory. To do this:

1. Click on `package.json` in your VS Code Navigator
2. Click on the `add new file` button
3. Name your new file `.env.local`

You can then copy the contents of the .env.local file from Supabase

In my case it's:

```txt filename=".env.local"
NEXT_PUBLIC_SUPABASE_URL=https://isxoflvoijeevdcqrstr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY= MY_SECRET_ANON_KEY
```

## Supbase Utils

Next up, we'll need to create some utility functions which handle Supabase Authentication.

In your src / root folder, create the following folders:

`/utils/supabase`

Then, in this folder, create the following files:

```ts filename="/utils/supabase/server.ts" copy
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'

export function createClient() {
  const cookieStore = cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options })
          } catch (error) {
            // The `set` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options })
          } catch (error) {
            // The `delete` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
```

```ts filename="/utils/supabase/client.ts" copy
import { createBrowserClient } from "@supabase/ssr";

export const createClient = () =>
  createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
```

```ts filename="/utils/supabase/middleware.ts" copy
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { type NextRequest, NextResponse } from "next/server";

export const createClient = (request: NextRequest) => {
  // Create an unmodified response
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          // If the cookie is updated, update the cookies for the request and response
          request.cookies.set({
            name,
            value,
            ...options,
          });
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });
          response.cookies.set({
            name,
            value,
            ...options,
          });
        },
        remove(name: string, options: CookieOptions) {
          // If the cookie is removed, update the cookies for the request and response
          request.cookies.set({
            name,
            value: "",
            ...options,
          });
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });
          response.cookies.set({
            name,
            value: "",
            ...options,
          });
        },
      },
    }
  );

  return { supabase, response };
};
```

```ts filename="utils/supabase/fetchUser.ts" copy 
import { createClient } from "@/utils/supabase/server";
export async function fetchUser() {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  return user;
}
```


## Supabase Login

Next, we'll set up login functionality.

In your main app directory, create a new file called `auth/confirm/route.ts`

```ts filename="auth/confirm/route.ts" copy
import { type EmailOtpType } from "@supabase/supabase-js";
import { type NextRequest, NextResponse } from "next/server";

import { createClient } from "@/utils/supabase/server";

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const token_hash = searchParams.get("token_hash");
  const type = searchParams.get("type") as EmailOtpType | null;
  const next = searchParams.get("next") ?? "/";

  const redirectTo = request.nextUrl.clone();
  redirectTo.pathname = next;
  redirectTo.searchParams.delete("token_hash");
  redirectTo.searchParams.delete("type");

  if (token_hash && type) {
    const supabase = createClient();

    const { error } = await supabase.auth.verifyOtp({
      type,
      token_hash,
    });
    if (!error) {
      redirectTo.searchParams.delete("next");
      return NextResponse.redirect(redirectTo);
    }
  }

  // return the user to an error page with some instructions
  redirectTo.pathname = "/error";
  return NextResponse.redirect(redirectTo);
}
```


### Login / Loginflow

Next we need to create a folder called `login`

Inside this folder we need a file called `loginFlow.ts` and a `page.tsx` file:

```ts filename="/login/loginFlow.ts" copy
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";

import { createClient } from "@/utils/supabase/server";

export async function login(formData: FormData) {
  const supabase = createClient();

  // type-casting here for convenience
  // in practice, you should validate your inputs
  const data = {
    email: formData.get("email") as string,
    password: formData.get("password") as string,
  };

  const { error } = await supabase.auth.signInWithPassword(data);

  if (error) {
    redirect("/error");
  }

  revalidatePath("/", "layout");
  redirect("/dashboard");
}

export async function signup(formData: FormData) {
  const supabase = createClient();

  // type-casting here for convenience
  // in practice, you should validate your inputs
  const data = {
    email: formData.get("email") as string,
    password: formData.get("password") as string,
  };

  const { error } = await supabase.auth.signUp(data);

  if (error) {
    redirect("/error");
  }

  revalidatePath("/", "layout");
  redirect("/");
}
```

For our login form, we also need to get the label UI element from ShadCN:

```sh copy
npx shadcn-ui@latest add label
```

Then we can setup our login page:

```tsx filename="/login/page.tsx" copy
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { login, signup } from './loginFlow'
 
export default function LoginForm() {
  return (
    <Card className="mx-auto max-w-sm">
      <CardHeader>
        <CardTitle className="text-2xl">Login</CardTitle>
        <CardDescription>
          Enter your email below to login to your account
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form>
          <div className="grid gap-4">
            <div className="grid gap-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                name="email"
                type="email"
                placeholder="m@example.com"
                required
              />
            </div>
            <div className="grid gap-2">
              <div className="flex items-center">
                <Label htmlFor="password">Password</Label>
              </div>
              <Input id="password" name="password" type="password" required />
            </div>
            <Button formAction={login} className="w-full">
              Login
            </Button>
          </div>
          <div className="mt-4 text-center text-sm flex flex-col gap-y-4">
            Don&apos;t have an account?{" "}
            <Button variant={'outline'} formAction={signup}>Sign up</Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

### Error Handling

We also need to add error handling, incase there's a problem during the login.

Create a new file called `error/page.tsx`

Then populate the file as such:

```tsx filename="error/page.tsx" copy
export default function ErrorPage() {
    return <p>Sorry, something went wrong</p>
  }
```

## Create a SignOut Component

Next, we'll need a SignOut component to allow our users to sign out.

We'll put this in our components folder:

```tsx filename="/components/SignOut.tsx" copy
import { createClient } from "@/utils/supabase/server";
import { redirect } from "next/navigation";

export default async function SignOut() {
  const supabase = createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  const signOut = async () => {
    "use server";

    const supabase = createClient();
    await supabase.auth.signOut();
    return redirect("/");
  };

  return user && (
    <div className="flex items-center gap-4">
      <form action={signOut}>
        <button className="py-2 px-3 rounded-md bg-red-400">
          Logout
        </button>
      </form>
    </div>
  ) 
}

```

## Add Login Page to NavBar

Last but not least, we can add our Login page to our navbar component:

```tsx filename="components/NavBar.tsx" copy
import Link from "next/link";
import React from "react";
import { Button } from "./ui/button";
import SignOut from "./SignOut";
import { createClient } from "@/utils/supabase/server";

interface User {
  id?: string;
  email?: string;
}

const fetchUser = async (): Promise<User | null> => {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user ? { id: user.id, email: user.email } : null;
};

export default async function NavBar() {
  const user = await fetchUser();

  const NavLinks = [
    {
      name: "Home",
      href: "/",
    },
    {
      name: "Contact",
      href: "/contact",
    },
  ];

  return (
    <div className="w-full flex justify-end gap-x-4 py-2 pr-4">
      {NavLinks.map((link) => (
        <Link
          key={link.name}
          href={link.href}
          style={{ textDecoration: "none" }}
        >
          <Button>{link.name}</Button>
        </Link>
      ))}
      {user ? (
        <div className="flex gap-x-4">
          <Link href="/dashboard">
            <Button>Dashboard</Button>
          </Link>
          <SignOut />
        </div>
      ) : (
        <Link href="/login" style={{ textDecoration: "none" }}>
          <Button>Login</Button>
        </Link>
      )}
    </div>
  );
}
```

And now, some 500 lines of code later, we have a functional login setup...

NB. Note that you'll need to confirm your email on supabase signup.

## Push to GitHub, Update Vercel

Once you've made all the changes on your local machine, you can push your changes to GitHub.

Remember that you need to write, save and close your commit message to make the push.

### Update Environment Variables on Vercel

You may have noticed that your `.env.local` file is slightly grayed out in the file explorer.

This is because it is listed in the .gitignore file. 

**YOU DO NOT WANT TO SHARE ENVIRONMENT VARIABLES PUBLICLY.**

To set the .env variables on Vercel, head over to your project deployment page and click 'settings'.

<Image
  src="/vercel_env.png"
  alt="Screenshot of vercel project management page."
  width={1000}
  height={1000}
/>

Then head over to Environment Variables:

<Image
  src="/vercel_env_set.png"
  alt="Screenshot of vercel Environment Variables page."
  width={1000}
  height={1000}
/>

You can then copy and paste the contents of your .env.local file into vercel, and then click save.

This will enable your Authentication to run on the web, and to connect to Supabase.

